<!DOCTYPE html>
<html>
<head>
    <title>Basic Chat Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #messages { border: 1px solid #ddd; height: 300px; padding: 15px; overflow-y: scroll; margin-bottom: 15px; background: #fafafa; border-radius: 5px; }
        #input { width: 70%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; }
        #send { padding: 12px 25px; background: #7c4dff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #send:hover { background: #6200ea; }
        .message { margin: 8px 0; padding: 8px 12px; border-radius: 8px; }
        .user { background-color: #e3f2fd; text-align: right; margin-left: 20%; }
        .bot { background-color: #f3e5f5; margin-right: 20%; }
        .status { background: #e8f5e8; border: 1px solid #4caf50; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { background: #ffebee; border: 1px solid #f44336; color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó CarHub Chatbot Test</h1>
        <p>This is a simple test page to verify the chatbot API is working correctly.</p>
        
        <div id="messages"></div>
        <input type="text" id="input" placeholder="Type your message here..." />
        <button id="send">Send Message</button>
        
        <div id="status" class="status">
            Ready to test! The chat widget should appear in the bottom-right corner.
        </div>
    </div>
    
    <!-- Include the CarHub Chat Widget -->
    {% include 'chat_widget.html' %}
    
    <script>
        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const status = document.getElementById('status');
        
        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function updateStatus(text, isError = false) {
            status.textContent = text;
            status.className = isError ? 'status error' : 'status';
        }
        
        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            
            addMessage(text, 'user');
            input.value = '';
            updateStatus('Sending message...');
            
            try {
                console.log('üöÄ Sending to API:', text);
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                
                console.log('üì• Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Response data:', data);
                
                if (data.success && data.message) {
                    addMessage(data.message, 'bot');
                    updateStatus('‚úÖ Message sent successfully!');
                } else {
                    throw new Error(data.error || 'No response message received');
                }
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                addMessage(`Error: ${error.message}`, 'bot');
                updateStatus(`‚ùå Error: ${error.message}`, true);
            }
        }
        
        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // Test API connection on load
        addMessage('Chat test page loaded. Try sending a message!', 'bot');
        updateStatus('‚úÖ Page loaded. API ready for testing.');
        
        // Check if chat widget loaded
        setTimeout(() => {
            const widget = document.getElementById('carhubChatWidget');
            if (widget) {
                updateStatus('‚úÖ Chat widget loaded successfully! Look for the üí¨ button in bottom-right corner.');
            } else {
                updateStatus('‚ö†Ô∏è Chat widget not found. Check console for errors.', true);
            }
        }, 1000);
    </script>
</body>
</html>
